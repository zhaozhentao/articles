åœ¨ç»§ç»­åˆ›å»ºè¿›ç¨‹ä¹‹å‰ï¼ˆ fork ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå¤„ç†ä¸€ä¸‹å†…å­˜åˆ†é…ç›¸å…³äº‹é¡¹ï¼Œç®€å•æ¥è¯´æ˜¯å› ä¸ºå°†æ¥åˆ›å»ºçš„æ¯ä¸ªè¿›ç¨‹éœ€è¦æœ‰å±äºè¯¥è¿›ç¨‹çš„å†…å­˜ç©ºé—´ï¼Œç”¨æ¥å­˜æ”¾ä»£ç å’Œæ•°æ®ï¼ˆä»£ç æ®µå’Œæ•°æ®æ®µï¼‰ã€‚åƒå‰é¢è¯´çš„å‡è®¾æˆ‘ä»¬çš„æœºå™¨ä¸€å…±æœ‰ 16M å†…å­˜ï¼Œé™¤å»å‰é¢å­˜æ”¾å†…æ ¸ä»£ç å’Œé«˜é€Ÿç¼“å†²åŒºå ç”¨çš„å†…å­˜ï¼Œå‰©ä¸‹çš„éƒ¨åˆ†æˆ‘ä»¬ç§°ä¸ºä¸»å†…å­˜ã€‚å›å¿†ä¸€ä¸‹å‰é¢çš„å†…å­˜åˆ†å¸ƒç¤ºæ„å›¾ã€‚

<div style="text-align: center">
<img src="http://coding.bozhen.live/upload/2023_05_03/08_21_10_image.png" style="width: 400px;">
</div>

ä¸Šé¢çš„ä¸»å†…å­˜å°±æ˜¯å°†æ¥å„ç§ç”¨æˆ·ç¨‹åºè¿è¡Œçš„èˆå°ã€‚

å†…æ ¸ä¸­ä½¿ç”¨ä¸€ä¸ªå­—èŠ‚æ•°ç»„ mem_map æ¥ç®¡ç†è¿™ä¸ªä¸»å†…å­˜åŒºï¼Œå’Œå‰é¢è¯´çš„ä¸€æ ·ï¼Œå†…å­˜æŒ‰ä¸€é¡µ 4k æ¥åˆ’åˆ†ï¼Œmem_map ä¸­æ¯é¡¹çš„æ•°å€¼ä»£è¡¨å…¶æ‰€æŒ‡å‘çš„ä¸€é¡µå†…å­˜è¢«å¼•ç”¨çš„æ¬¡æ•°ã€‚

æˆ‘ä»¬éœ€è¦åœ¨å†…æ ¸å¯åŠ¨é˜¶æ®µåˆå§‹åŒ–ä¸€ä¸‹ä¸Šé¢è¯´çš„è¿™ä¸ª mem_map æ•°ç»„ã€‚ä¸‹é¢å°±æ˜¯å…¶åˆå§‹åŒ–å‡½æ•° mem_init ã€‚è¯¥å‡½æ•°é¦–å…ˆå°†æ‰€æœ‰æ•°ç»„é¡¹éƒ½æ ‡è®°ä¸ºå ç”¨ï¼Œç„¶åå†ä»çœŸæ­£å¯åˆ†é…çš„å†…å­˜é¡µå¼€å§‹ï¼Œå°†æ•°ç»„é¡¹æ¸…é›¶ï¼Œè¡¨ç¤ºå¯åˆ†é…ã€‚ä»ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œmem_map çš„ 0 å·å…ƒç´ æŒ‡å‘ 1M å¤„ï¼Œè€Œ 1M åˆ°ä¸Šå›¾ä¸­çš„ main_memory_start ä¹‹é—´çš„å†…å­˜å®é™…ä¸Šæ˜¯å†…æ ¸å ç”¨çš„ï¼Œæ‰€ä»¥åˆå§‹åŒ–æ—¶ç›´æ¥æ ‡è®°ä¸º USEDã€‚

```diff
diff --git a/mm/memory.c b/mm/memory.c
new file mode 100644
index 0000000..d0c7ad6
--- /dev/null
+++ b/mm/memory.c
@@ -0,0 +1,28 @@
+#define LOW_MEM 0x100000
+#define PAGING_MEMORY (15*1024*1024)           // ä¸»å†…å­˜æœ€å¤š15M
+#define PAGING_PAGES (PAGING_MEMORY>>12)       // åˆ†é¡µåçš„å†…å­˜é¡µæ•°
+#define MAP_NR(addr) (((addr)-LOW_MEM)>>12)    // å†…å­˜åœ°å€æ˜ å°„ä¸ºé¡µå·
+#define USED 100
+
+static long HIGH_MEMORY = 0;
+
+// ç‰©ç†å†…å­˜å­—èŠ‚æ˜ å°„å›¾ï¼Œä¸€å­—èŠ‚ä»£è¡¨ä¸€é¡µ (4K) ï¼Œæ¯ä¸ªå­—èŠ‚ä¿å­˜çš„æ•°å€¼è¡¨ç¤ºè¯¥å†…å­˜é¡µè¢«å¼•ç”¨çš„æ¬¡æ•°
+static unsigned char mem_map [ PAGING_PAGES ] = {0,};
+
+void mem_init(long start_mem, long end_mem)
+{
+    int i;
+
+    // é¦–å…ˆç®€å•å°†æ‰€æœ‰æ•°ç»„é¡¹éƒ½æ ‡è®°ä¸ºå ç”¨
+    HIGH_MEMORY = end_mem;
+    for (i=0 ; i<PAGING_PAGES ; i++)
+        mem_map[i] = USED;
+    // è®¡ç®—ç¬¬ä¸€ä¸ªå¯åˆ†é…çš„å†…å­˜é¡µå·
+    i = MAP_NR(start_mem);
+    end_mem -= start_mem;
+    end_mem >>= 12;
+    // ä»ç¬¬ä¸€ä¸ªå¯åˆ†é…çš„é¡µå·å¼€å§‹å°†æ˜ å°„å›¾æ•°ç»„æ¸…é›¶ï¼Œç›´åˆ°æœ€åä¸€é¡µï¼Œè¡¨ç¤ºåé¢çš„å†…å­˜é¡µå…¨éƒ¨å¯ç”¨
+    while (end_mem-->0)
+        mem_map[i++]=0;
+}
+
```

ç”¨ä¸€ä¸ªå›¾æ¥ç¤ºæ„åˆå§‹åŒ–åçš„ç»“æœã€‚

<div style="text-align: center">
<img src="http://coding.bozhen.live/upload/2023_10_04/21_58_15_image.png" style="width: 600px;">
</div>

åœ¨ main å‡½æ•°ä¸­è°ƒç”¨ä¸Šé¢çš„åˆå§‹åŒ–å‡½æ•°ã€‚

```diff
diff --git a/init/main.c b/init/main.c
index 23b10a4..e4011a2 100644
--- a/init/main.c
+++ b/init/main.c
@@ -37,6 +37,7 @@ void main(void) {
         buffer_memory_end = 1*1024*1024;         // å¦‚æœå†…å­˜å°äº 6M ï¼Œåˆ™ 1M ä»¥ä¸‹çš„å†…å­˜å½’å†…æ ¸ä½¿ç”¨
     main_memory_start = buffer_memory_end;       // main_memory_start å°±æ˜¯å°†æ¥ç”¨æ¥è¿è¡Œåº”ç”¨ç¨‹åºçš„å†…å­˜ï¼Œä»¥å†…æ ¸å†…å­˜ç»“æŸçš„åœ°
 
+    mem_init(main_memory_start,memory_end);
     con_init();
     trap_init();
     blk_dev_init();                                 // åˆå§‹åŒ–å—è®¾å¤‡ç»“æ„
```

ä¿®æ”¹ä¸€ä¸‹ Makefile ä½¿ä¸Šé¢çš„ä»£ç ç”Ÿæ•ˆã€‚

```diff
diff --git a/mm/Makefile b/mm/Makefile                                                                              [0/17]
new file mode 100644
index 0000000..b23b84d
--- /dev/null
+++ b/mm/Makefile
@@ -0,0 +1,31 @@
+include ../Makefile.header
+
+LDFLAGS += -r
+CFLAGS += -I../include
+CPP    += -I../include
+
+.c.o:
+       @$(CC) $(CFLAGS) \
+       -c -o $*.o $<
+.s.o:
+       @$(AS) -o $*.o $<
+.c.s:
+       @$(CC) $(CFLAGS) \
+       -S -o $*.s $<
+
+OBJS = memory.o
+
+all: mm.o
+
+mm.o: $(OBJS)
+       $(LD) $(LDFLAGS) -o mm.o $(OBJS)
+
+clean:
+       rm -f core *.o *.a tmp_make
+       for i in *.c;do rm -f `basename $$i .c`.s;done
+
+memory.o: memory.c ../include/signal.h ../include/sys/types.h \
+  ../include/asm/system.h ../include/linux/sched.h \
+  ../include/linux/head.h ../include/linux/fs.h ../include/linux/mm.h \
+  ../include/linux/kernel.h
+
```

```diff
diff --git a/Makefile b/Makefile
index d9f3767..122cd14 100644
--- a/Makefile
+++ b/Makefile
@@ -5,7 +5,7 @@ include Makefile.header
 LDFLAGS        += -Ttext 0 -e startup_32
 CFLAGS += -Iinclude
 
-ARCHIVES=kernel/kernel.o fs/fs.o
+ARCHIVES=kernel/kernel.o mm/mm.o fs/fs.o
 DRIVERS=kernel/blk_drv/blk_drv.a kernel/chr_drv/chr_drv.a
 LIBS   =lib/lib.a
 
@@ -26,6 +26,9 @@ Image: boot/bootsect boot/setup tools/system
        tools/build.sh boot/bootsect boot/setup tools/kernel Image
        $(OBJDUMP) -D -m i386 tools/system > system.dis
 
+mm/mm.o:
+       make -C mm
+
 fs/fs.o:
        make -C fs
 
@@ -68,7 +71,7 @@ stop:
 
 clean:
        rm -f Image *.dis *.tmp init/*.o system.debug System.map
-       for i in boot fs kernel lib; do make clean -C $$i; done
+       for i in mm fs kernel lib boot; do make clean -C $$i; done
 
 init/main.o: init/main.c
 
```

### å°ç»“

æœ¬èŠ‚ä¸»è¦åˆå§‹åŒ–äº†ç”¨æ¥ç®¡ç†å†…å­˜é¡µçš„æ•°ç»„ mem_map ï¼Œè®¤è¯†äº†ä¸»å†…å­˜å¤§æ¦‚çš„åˆ†å¸ƒã€‚

```shell
git add .
git commit -m "åˆå§‹åŒ– mem_map ç»“æ„"
```

æ¬¢åº¦å›½åº† ğŸ‰ ã€‚
